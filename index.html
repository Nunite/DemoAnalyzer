<!DOCTYPE html>
<html>

<head>
    <title>Simple Demo Analyzer</title>
    <link rel="stylesheet" type="text/css" href="css/basestyles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/hldemo.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/demoDataConverter.js"></script>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            console.error('Error: ' + msg + '\nurl: ' + url + '\nline: ' + line);
            return false;
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="upload-btn-container">
        <label for="fileInput">
            <img src="img/upload.png" alt="上传">
            上传文件
        </label>
        <input type="file" id="fileInput" accept=".dem" style="display: none;" onchange="handleFileUpload(event)">
        
    </div>
    <div class="author-info">
        <span>DemoGraphViewer by Lws</span>
        <a href="https://github.com/Nunite/DemoAnalyzer" target="_blank">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub">
            GitHub
        </a>
    </div>
    <div class="container">
        <!-- 左侧文件面板 -->
        <div class="sidebar">
            <div class="file-list" id="fileList">
                <div class="file-list-header">
                    <h3>已加载文件</h3>
                </div>
                <div id="fileTableContainer"></div>
            </div>
        </div>
        <button class="sidebar-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">☰</button>

        <!-- 主要内容区域 -->
        <div class="main-content">
            <div class="chart-container">
                <div id="chartContainer" class="echarts-container"></div>
            </div>
        </div>

        <!-- 右侧控制面板 -->
        <div class="right-panel">
            <h3>工具选项</h3>
            <div class="tool-option">
                <label>
                    <input type="checkbox" id="showTBJ" onchange="toggleTBJDisplay()">
                    TBJ显示
                </label>
            </div>
            <div id="tbjStats" class="tbj-panel">
                <h4>TBJ 统计</h4>
                <div class="stat-item">
                    <label>总跳跃数:</label>
                    <span id="totalJumps">-</span>
                </div>
                <div class="stat-item">
                    <label>成功TBJ次数:</label>
                    <span id="successfulTBJ">-</span>
                </div>
                <div class="stat-item">
                    <label>TBJ成功率:</label>
                    <span id="tbjSuccessRate" class="highlight-stat">-</span>
                </div>
                <div class="stat-item">
                    <label>最大连续TBJ次数:</label>
                    <span id="maxConsecutiveTBJ" class="highlight-stat">-</span>
                </div>
                <div class="stat-item">
                    <label>连续TBJ详情:</label>
                    <div id="consecutiveTBJDetails"></div>
                </div>
                <div class="disclaimer">
                    注意：本工具的分析结果仅供参考，请勿盲目作为判定依据
                </div>
            </div>
            <div id="speedStats" class="tbj-panel">
                <h4>平均速度统计</h4>
                <div id="timerSpeedDetails">
                    <!-- 动态填充计时器速度数据 -->
                </div>
                <div class="disclaimer">
                    注意：速度统计基于计时器起止帧计算
                </div>
            </div>
            <hr style="margin: 20px 0;">
            <h3>记录对比</h3>
            <div class="compare-records">
                <button id="compareRecordsBtn" class="compare-btn" onclick="openCompareDialog()">
                    对比记录
                </button>
            </div>
            
            <!-- 添加对比记录的弹窗 -->
            <div id="compareDialog" class="modal">
                <div class="modal-content">
                    <h4>选择要对比的记录</h4>
                    <div class="record-select">
                        <div class="record-item">
                            <label>新记录:</label>
                            <select id="newRecordSelect"></select>
                        </div>
                        <div class="record-item">
                            <label>老记录:</label>
                            <select id="oldRecordSelect"></select>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button onclick="compareRecords()">开始对比</button>
                        <button onclick="closeCompareDialog()">取消</button>
                    </div>
                </div>
            </div>
            <hr style="margin: 20px 0;">
            <h3>颜色设置</h3>
            <div class="command-options">
                <!-- 颜色选择器 -->
                <div class="command-option">
                    <input type="color" class="color-picker" id="yaw-speed-color" value="#1E90FF"
                        style="display: none;">
                    <span class="color-indicator" style="background: #1E90FF"></span>
                    <label>Yaw Speed</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="use-color" value="#FF4500" style="display: none;">
                    <span class="color-indicator" style="background: #FF4500"></span>
                    <label>use</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="moveleft-color" value="#32CD32" style="display: none;">
                    <span class="color-indicator" style="background: #32CD32"></span>
                    <label>moveleft</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="moveright-color" value="#9370DB"
                        style="display: none;">
                    <span class="color-indicator" style="background: #9370DB"></span>
                    <label>moveright</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="moveforward-color" value="#FFD700"
                        style="display: none;">
                    <span class="color-indicator" style="background: #FFD700"></span>
                    <label>moveforward</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="moveback-color" value="#FF69B4"
                        style="display: none;">
                    <span class="color-indicator" style="background: #FF69B4"></span>
                    <label>moveback</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="jump-color" value="#00CED1" style="display: none;">
                    <span class="color-indicator" style="background: #00CED1"></span>
                    <label>jump</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="valid-jump-color" value="#00FF00"
                        style="display: none;">
                    <span class="color-indicator" style="background: #00FF00"></span>
                    <label>Valid jump</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="ground-color" value="#808080" style="display: none;">
                    <span class="color-indicator" style="background: #808080"></span>
                    <label>ground</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="duck-color" value="#8B4513" style="display: none;">
                    <span class="color-indicator" style="background: #8B4513"></span>
                    <label>duck</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="duck-start-color" value="#A0522D"
                        style="display: none;">
                    <span class="color-indicator" style="background: #A0522D"></span>
                    <label>Duck start</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="duck-end-color" value="#8B4513" style="display: none;">
                    <span class="color-indicator" style="background: #8B4513"></span>
                    <label>Duck end</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="forward-color" value="#4682B4" style="display: none;">
                    <span class="color-indicator" style="background: #4682B4"></span>
                    <label>forward</label>
                </div>
                <div class="command-option">
                    <input type="color" class="color-picker" id="back-color" value="#CD5C5C" style="display: none;">
                    <span class="color-indicator" style="background: #CD5C5C"></span>
                    <label>back</label>
                </div>
            </div>
        </div>
        <button class="right-panel-toggle"
            onclick="document.querySelector('.right-panel').classList.toggle('open')">☰</button>
    </div>

    <script>
        let chart = null;
        let loadedFiles = []; // 存储已加载的文件
        let chartState = {
            dataZoom: null  // 存储滑块状态
        };
        let currentDemoData = null; // 存储当前的demo数据
        let AllFramesNum = null; // 存储帧数据
        //let currentFileName =null; // 存储当前文件名

        function handleFileUpload(event) {
            console.log('文件上传开始');
            const files = event.target.files;
            console.log('文件数量:', files.length);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('处理文件:', file.name);

                const reader = new FileReader();

                reader.onload = function (e) {
                    console.log('文件已加载:', file.name);
                    const demoReader = new HLDemo.DemoReader();

                    demoReader.onready = function () {
                        console.log('Demo解析成功');
                        try {
                            const frames = demoReader.directoryEntries[1].frames;
                            
                            console.log('帧数:', frames.length);

                            // 使用main.js中的parseFrames处理数据
                            const parsedData = parseFrames(frames);
                            console.log('解析后的数据:', parsedData);

                            // 显示文件名
                            //document.getElementById('fileName').textContent = '当前文件: ' + file.name;

                            // 初始化图表
                            const chartData = convertDemoData(parsedData);
                            chartData.fileName = file.name;  // 添加文件名到数据中
                            //currentFileName=file.name;
                            initChart(chartData);

                            // 更新TBJ统计信息
                            const tbjStats = analyzeTBJFromParsedData(parsedData);
                            document.getElementById('totalJumps').textContent = tbjStats.totalJumps;
                            document.getElementById('successfulTBJ').textContent = tbjStats.successfulTBJ;
                            document.getElementById('tbjSuccessRate').textContent = tbjStats.tbjSuccessRate;
                            document.getElementById('maxConsecutiveTBJ').textContent = tbjStats.maxConsecutiveTBJ;
                            
                            // 显示连续TBJ的详细信息
                            const detailsElement = document.getElementById('consecutiveTBJDetails');
                            if (tbjStats.consecutiveTBJData && tbjStats.consecutiveTBJData.length > 0) {
                                const details = tbjStats.consecutiveTBJData
                                    .filter(data => data.count > 1)  // 只显示连续次数大于1的
                                    .sort((a, b) => b.count - a.count)  // 按连续次数从大到小排序
                                    .map(data => {
                                        const frames = `帧 ${data.startFrame}-${data.endFrame}`;
                                        return `<div class="consecutive-item">${frames}: ${data.count} 次</div>`;
                                    })
                                    .join('');
                                detailsElement.innerHTML = details || '<div class="consecutive-item">无连续TBJ</div>';
                            } else {
                                detailsElement.innerHTML = '<div class="consecutive-item">无连续TBJ</div>';
                            }
                        } catch (error) {
                            console.error('处理Demo时出错:', error);
                        }
                    };

                    demoReader.parse(file);
                };

                reader.onerror = function (error) {
                    console.error('文件读取错误:', error);
                };

                reader.readAsArrayBuffer(file);
            }
        }

        function initChart(demoData) {
            // 保存当前的dataZoom状态（如果存在）
            if (chart && chart.getOption()) {
                const currentOption = chart.getOption();
                if (currentOption.dataZoom) {
                    chartState.dataZoom = currentOption.dataZoom;
                }
            }

            // 如果已经存在图表实例，销毁它
            if (chart) {
                chart.dispose();
            }

            // 初始化新的图表实例
            chart = echarts.init(document.getElementById('chartContainer'));

            const option = {
                title: [
                    { text: '当前文件：' + demoData.fileName, left: 'center', top: 10, textStyle: { fontSize: 14, color: '#ffffff' } },
                    { top: 205, left: 5, text: "Yaw Speed", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 345, left: 5, text: "use", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 375, left: 5, text: "moveleft", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 405, left: 5, text: "moveright", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 435, left: 5, text: "moveforward", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 465, left: 5, text: "moveback", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 495, left: 5, text: "jump", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 525, left: 5, text: "ground", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 555, left: 5, text: "duck", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 585, left: 5, text: "forward", textStyle: { fontSize: 12, color: '#ffffff' } },
                    { top: 615, left: 5, text: "back", textStyle: { fontSize: 12, color: '#ffffff' } }
                ],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        // 找到当前帧的索引
                        const frameIndex = params[0].dataIndex;
                        const frame = demoData.data[frameIndex].frame;

                        // 构建显示信息
                        let result = `Frame: ${frame}<br/>`;

                        // 获取所有数据系列的值
                        const seriesValues = {
                            'Yaw Speed': demoData.data[frameIndex].yawSpeed,
                            'Horizontal Speed': demoData.data[frameIndex].horizontalSpeed, // 添加水平速度
                            //'Vertical Speed': demoData.data[frameIndex].verticalSpeed,  // 添加垂直速度
                            'fuser2':demoData.data[frameIndex].fuser2,
                            'use': demoData.data[frameIndex].use ? 'Yes' : 'No',
                            'moveleft': demoData.data[frameIndex].moveLeft ? 'Yes' : 'No',
                            'moveright': demoData.data[frameIndex].moveRight ? 'Yes' : 'No',
                            'moveforward': demoData.data[frameIndex].moveForward ? 'Yes' : 'No',
                            'moveback': demoData.data[frameIndex].moveBack ? 'Yes' : 'No',
                            'jump': demoData.data[frameIndex].jump ? 'Yes' : 'No',
                            'ground': demoData.data[frameIndex].ground ? 'Yes' : 'No',
                            'duck': demoData.data[frameIndex].duck ? 'Yes' : 'No',
                            'forward': demoData.data[frameIndex].forward ? 'Yes' : 'No',
                            'back': demoData.data[frameIndex].back ? 'Yes' : 'No'
                        };

                        // 添加每个系列的值
                        Object.entries(seriesValues).forEach(([name, value]) => {
                            if (typeof value === 'number') {
                                result += `${name}: ${value.toFixed(6)}<br/>`;
                            } else {
                                result += `${name}: ${value}<br/>`;
                            }
                        });

                        return result;
                    },
                    backgroundColor: 'rgba(44, 44, 46, 0.95)',  // 暗色背景
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    padding: [5, 10],
                    textStyle: {
                        color: '#ffffff'  // 白色文字
                    }
                },
                dataZoom: [{
                    type: 'slider',
                    xAxisIndex: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    top: 50,
                    height: 20,
                    zoomOnMouseWheel: 'ctrl',
                    moveOnMouseWheel: true,
                    moveOnMouseMove: false,
                    backgroundColor: '#2c2c2e',  // 暗色背景
                    fillerColor: 'rgba(167, 167, 167, 0.2)',  // 选择区域颜色
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    handleStyle: {
                        color: '#98989d'  // 滑块颜色
                    },
                    textStyle: {
                        color: '#ffffff'  // 文字颜色
                    }
                }, {
                    type: 'inside',
                    xAxisIndex: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    zoomOnMouseWheel: 'ctrl',
                    moveOnMouseWheel: true,
                    moveOnMouseMove: false
                }],
                grid: [
                    { left: 120, right: 20, top: 90, height: 250, borderWidth: 2, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 340, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 370, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 400, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 430, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 460, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 490, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 520, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 550, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 580, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' },
                    { left: 120, right: 20, height: 30, top: 610, borderWidth: 1, show: true, borderColor: 'rgba(255, 255, 255, 0.1)', backgroundColor: 'rgba(44, 44, 46, 0.5)' }
                ],
                xAxis: Array.from({ length: 11 }, (_, i) => ({
                    type: 'category',
                    data: demoData.data.map(d => d.frame),
                    gridIndex: i,
                    show: i === 10,
                    axisLabel: { show: i === 10, color: '#ffffff' },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        }
                    },
                    splitLine: {
                        //show: i === 10,  // 只在最后一个轴显示网格线
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                })),
                yAxis: Array.from({ length: 11 }, (_, i) => ({
                    type: 'value',
                    gridIndex: i,
                    show: true,
                    axisLine: { show: false },
                    axisTick: { show: i === 0, lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    splitLine: { 
                        show: i === 0,
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    axisLabel: { show: i === 0, color: '#ffffff' },
                    min: i === 0 ? null : 0,
                    max: i === 0 ? null : 1
                })),
                series: [
                    {
                        name: 'Yaw Speed',
                        type: 'line',
                        data: demoData.data.map(d => d.yawSpeed),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('yaw-speed-color', '#1E90FF')
                        }
                    },
                    {
                        name: 'use',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: demoData.data.map(d => d.use),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('use-color', '#FF4500')
                        }
                    },
                    {
                        name: 'moveleft',
                        type: 'bar',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        data: demoData.data.map(d => d.moveLeft ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('moveleft-color', '#32CD32')
                        }
                    },
                    {
                        name: 'moveright',
                        type: 'bar',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        data: demoData.data.map(d => d.moveRight ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('moveright-color', '#9370DB')
                        }
                    },
                    {
                        name: 'moveforward',
                        type: 'bar',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        data: demoData.data.map(d => d.moveForward ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('moveforward-color', '#FFD700')
                        }
                    },
                    {
                        name: 'moveback',
                        type: 'bar',
                        xAxisIndex: 5,
                        yAxisIndex: 5,
                        data: demoData.data.map(d => d.moveBack ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('moveback-color', '#FF69B4')
                        }
                    },
                    {
                        name: 'jump',
                        type: 'bar',
                        xAxisIndex: 6,
                        yAxisIndex: 6,
                        data: demoData.data.map(d => ({
                            value: d.jump ? 1 : 0,
                            itemStyle: {
                                color: d.validJump ? getColorValue('valid-jump-color', '#00FF00') :
                                    getColorValue('jump-color', '#00CED1')
                            }
                        })),
                        animation: false,
                        show: true
                    },
                    {
                        name: 'ground',
                        type: 'bar',
                        xAxisIndex: 7,
                        yAxisIndex: 7,
                        data: demoData.data.map(d => d.ground ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('ground-color', '#808080')
                        }
                    },
                    {
                        name: 'duck',
                        type: 'bar',
                        xAxisIndex: 8,
                        yAxisIndex: 8,
                        data: demoData.data.map((d, index, array) => {
                            if (!d.duck) return 0;

                            // 检查当前帧是否是一段连续duck的起始或结束
                            let isStart = false;
                            let isEnd = false;

                            // 判断是否是起始帧：当前帧是duck且前一帧不是duck
                            if (index === 0 || !array[index - 1].duck) {
                                isStart = true;
                            }

                            // 判断是否是结束帧：当前帧是duck且后一帧不是duck
                            if (index === array.length - 1 || !array[index + 1].duck) {
                                isEnd = true;
                            }

                            // 根据帧的位置返回不同的样式
                            return {
                                value: 1,
                                itemStyle: {
                                    color: isStart ? getColorValue('duck-start-color', '#A0522D') :
                                        isEnd ? getColorValue('duck-end-color', '#8B4513') :
                                            getColorValue('duck-color', '#8B4513')
                                }
                            };
                        }),
                        animation: false,
                        show: true
                    },
                    {
                        name: 'forward',
                        type: 'bar',
                        xAxisIndex: 9,
                        yAxisIndex: 9,
                        data: demoData.data.map(d => d.forward ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('forward-color', '#4682B4')
                        }
                    },
                    {
                        name: 'back',
                        type: 'bar',
                        xAxisIndex: 10,
                        yAxisIndex: 10,
                        data: demoData.data.map(d => d.back ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: getColorValue('back-color', '#CD5C5C')
                        }
                    }
                ]
            };

            // 在设置新的options之前，恢复之前保存的dataZoom状态
            if (chartState.dataZoom) {
                option.dataZoom = chartState.dataZoom;
            }

            chart.setOption(option);

            // 设置全局背景色
            chart.setOption({
                backgroundColor: '#1c1c1e',  // 与页面背景色一致
                // ... other options
            });
        }
        
        function downloadchart(filename,frameNum){
        filename=filename.split('.').slice(0, -1).join('.');
        const chartContainer = document.querySelector('.chart-container');
        //currentDemoData.fileName = currentFileName;
        // 设置宽度（支持百分比/像素值）
        const tempwidth = chartContainer.style.width;
        customwidth = Math.ceil(AllFramesNum / 196 * 10) + '%';
        console.log(customwidth); // 输出 "4080%"

        chartContainer.style.width = customwidth; 
        initChart(currentDemoData);
            // 获取图表实例后
            const imgUrl = chart.getDataURL({
            type: 'png',
            pixelRatio: 2, // 提高清晰度
            excludeComponents: ['toolbox'], // 排除不必要组件
            backgroundColor: '#1c1c1e' // 设置背景
            });
            
            // 下载图片
            const link = document.createElement('a');
            link.download = filename+'.png';
            link.href = imgUrl;
            link.click();
            chartContainer.style.width = tempwidth;
            initChart(currentDemoData);
        }

        function getColorValue(elementId, defaultColor) {
            const element = document.getElementById(elementId);
            return element ? element.value : defaultColor;
        }

        function analyzeDemo() {
            // 加载示例 .xhr 文件
            fetch('hrbg_rabbitrun_outside_0121.59.xhr')
                .then(response => response.json())
                .then(demoData => {
                    //document.getElementById('fileName').textContent = '当前文件：' + demoData.fileName;
                    initChart(demoData);
                })
                .catch(error => {
                    alert("Could not load example demo file");
                });
        }

        // 页面加载时不自动初始化图表，等待用户操作
        window.addEventListener('load', () => {
            // 可以选择自动加载示例文件
            // analyzeDemo();
        });

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            chart && chart.resize();
        });

        document.addEventListener('DOMContentLoaded', function () {
            const colorPickers = document.querySelectorAll('.color-picker');
            const colorIndicators = document.querySelectorAll('.color-indicator');

            // 为颜色指示器添加点击事件
            colorIndicators.forEach(indicator => {
                indicator.addEventListener('click', function() {
                    // 找到对应的颜色选择器并触发点击
                    const picker = this.previousElementSibling;
                    if (picker && picker.classList.contains('color-picker')) {
                        picker.click();
                    }
                });
            });

            // 加载保存的颜色
            colorPickers.forEach(picker => {
                const savedColor = localStorage.getItem(picker.id);
                if (savedColor) {
                    picker.value = savedColor;
                    picker.nextElementSibling.style.background = savedColor;
                    const seriesName = picker.parentNode.querySelector('label').textContent.trim();
                    updateChartColor(seriesName, savedColor);
                }

                picker.addEventListener('input', function () {
                    const selectedColor = this.value;
                    this.nextElementSibling.style.background = selectedColor;
                    localStorage.setItem(this.id, selectedColor);
                    const seriesName = this.parentNode.querySelector('label').textContent.trim();
                    updateChartColor(seriesName, selectedColor);
                });
            });
        });

        function updateChartColor(seriesName, color) {
            if (!chart || !currentDemoData) return;
            
            // 更新当前series的颜色
            const option = chart.getOption();
            
            // 处理特殊颜色更新
            if (seriesName === 'Valid jump') {
                // 当修改valid jump颜色时，更新jump系列
                const jumpIndex = option.series.findIndex(s => s.name === 'jump');
                if (jumpIndex !== -1) {
                    option.series[jumpIndex].data = currentDemoData.data.map(d => ({
                        value: d.jump ? 1 : 0,
                        itemStyle: {
                            color: d.validJump ? color : getColorValue('jump-color', '#00CED1')
                        }
                    }));
                    chart.setOption(option);
                }
                return;
            }
            
            if (seriesName === 'Duck start' || seriesName === 'Duck end') {
                // 当修改duck start或end颜色时，更新duck系列
                const duckIndex = option.series.findIndex(s => s.name === 'duck');
                if (duckIndex !== -1) {
                    option.series[duckIndex].data = currentDemoData.data.map((d, index, array) => {
                        if (!d.duck) return 0;

                        let isStart = false;
                        let isEnd = false;

                        if (index === 0 || !array[index - 1].duck) {
                            isStart = true;
                        }

                        if (index === array.length - 1 || !array[index + 1].duck) {
                            isEnd = true;
                        }

                        return {
                            value: 1,
                            itemStyle: {
                                color: isStart ? getColorValue('duck-start-color', '#A0522D') :
                                    isEnd ? getColorValue('duck-end-color', '#8B4513') :
                                        getColorValue('duck-color', '#8B4513')
                            }
                        };
                    });
                    chart.setOption(option);
                }
                return;
            }

            // 处理普通命令的颜色更新
            const seriesIndex = option.series.findIndex(s => s.name === seriesName);
            if (seriesIndex !== -1) {
                // 特殊处理jump和duck命令
                if (seriesName === 'jump') {
                    // 更新jump的数据
                    option.series[seriesIndex].data = currentDemoData.data.map(d => ({
                        value: d.jump ? 1 : 0,
                        itemStyle: {
                            color: d.validJump ? getColorValue('valid-jump-color', '#00FF00') :
                                color
                        }
                    }));
                } else if (seriesName === 'duck') {
                    // 更新duck的数据
                    option.series[seriesIndex].data = currentDemoData.data.map((d, index, array) => {
                        if (!d.duck) return 0;

                        let isStart = false;
                        let isEnd = false;

                        if (index === 0 || !array[index - 1].duck) {
                            isStart = true;
                        }

                        if (index === array.length - 1 || !array[index + 1].duck) {
                            isEnd = true;
                        }

                        return {
                            value: 1,
                            itemStyle: {
                                color: isStart ? getColorValue('duck-start-color', '#A0522D') :
                                    isEnd ? getColorValue('duck-end-color', '#8B4513') :
                                        color
                            }
                        };
                    });
                } else {
                    // 普通命令的颜色更新
                    option.series[seriesIndex].itemStyle = option.series[seriesIndex].itemStyle || {};
                    option.series[seriesIndex].itemStyle.color = color;
                }
                
                chart.setOption(option);
            }
        }

        function toggleTBJDisplay() {
            const tbjPanel = document.getElementById('tbjStats');
            const showTBJ = document.getElementById('showTBJ').checked;
            tbjPanel.style.display = showTBJ ? 'block' : 'none';
        }

        // 页面加载时初始化TBJ面板显示状态
        window.addEventListener('load', () => {
            toggleTBJDisplay();
            // 初始化文件列表
            generateFileTable('#fileList');
        });

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('fileStore', 1);

                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore('files', { keyPath: 'id' });
                };

                request.onsuccess = (e) => {
                    resolve(e.target.result);
                };

                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function retrieveAllFiles() {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        resolve(request.result);
                    };

                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function processFileFromDatabase(file_id, index = 0) {
            retrieveFile(file_id)
                .then(({ file }) => {
                    // 更新文件名标题
                    //document.getElementById('currentFileName').textContent = '当前文件：' + file.name;
                    processFile(file, index);
                })
                .catch((error) => {
                    console.error('Error processing file from database:', error);
                });
        }

        function retrieveFile(file_id) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(file_id);

                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        if (result) {
                            resolve({
                                file: result.file,
                                metadata: result.metadata || {}
                            });
                        } else {
                            reject('File not found');
                        }
                    };

                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function formatFileSize(sizeInBytes) {
            const units = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            let size = sizeInBytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return `${minutes} 分钟前`;
                }
                return `${hours} 小时前`;
            } else if (days < 7) {
                return `${days} 天前`;
            } else {
                return new Date(date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function generateFileTable(containerClass) {
            retrieveAllFiles()
                .then((files) => {
                    files.reverse();
                    let html = '<h3>已加载文件</h3>';
                    html += '<table>';
                    html += '<tbody>';

                    files.forEach(file => {
                        const data = file.file;
                        const timeStr = formatDate(data.lastModified);

                        html += `
                        <tr>
                            <td>
                                <div class="file-info">
                                    <a href="#" class="file-name" onclick="processFileFromDatabase('${data.name}', 99);" title="${data.name}">
                                        ${data.name.length > 25 ? data.name.substring(0, 22) + '...' : data.name}
                                    </a>
                                    <div class="download-buttons">
                                        <div class="dropdown">
                                            <img src="img/download.png" class="action-btn" title="下载数据">
                                            <div class="dropdown-content">
                                                <a href="#" onclick="downloadFogData('${data.name}')">FOG数据</a>
                                                <a href="#" onclick="downloadDemoData('${data.name}')">Demo数据</a>
                                                <a href="#" onclick="downloadFramesData('${data.name}')">Frames数据</a>
                                                <a href="#" onclick="downloadchart('${data.name},${AllFramesNum}')">图表图片</a>
                                            </div>
                                        </div>
                                        <span class="delete-btn" onclick="deleteFile('${data.name}')" title="删除">×</span>
                                    </div>
                                </div>
                                <div class="file-time">${timeStr}</div>
                            </td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                    document.querySelector(containerClass).innerHTML = html;
                })
                .catch((error) => {
                    console.error('Error retrieving files:', error);
                });
        }

        function deleteFile(fileId) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.delete(fileId);

                    request.onsuccess = () => {
                        generateFileTable('#fileList');
                        resolve('File deleted successfully');
                    };

                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function storeFile(file) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = {
                        id: file.name,
                        file: file
                    };
                    const request = store.put(fileData);

                    request.onsuccess = () => {
                        resolve('File stored successfully');
                    };

                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function processFile(file, index = 0) {
            storeFile(file).then(() => {
                const demoReader = new HLDemo.DemoReader();
                demoReader.onready(function() {
                    const frames = demoReader.directoryEntries[1].frames;
                    const parsedData = parseFrames(frames);
                    //console.log(parsedData);
                    // 初始化图表
                    const chartData = convertDemoData(parsedData, file.name);
                    //console.log(chartData);
                    chartData.fileName = file.name;
                    currentDemoData = chartData;
                    initChart(chartData);
                    AllFramesNum = frames.length;
                    
                    // 更新TBJ统计信息
                    const tbjStats = analyzeTBJFromParsedData(parsedData);
                    document.getElementById('totalJumps').textContent = tbjStats.totalJumps;
                    document.getElementById('successfulTBJ').textContent = tbjStats.successfulTBJ;
                    document.getElementById('tbjSuccessRate').textContent = tbjStats.tbjSuccessRate;
                    document.getElementById('maxConsecutiveTBJ').textContent = tbjStats.maxConsecutiveTBJ;
                    
                    // 显示连续TBJ的详细信息
                    const detailsElement = document.getElementById('consecutiveTBJDetails');
                    if (tbjStats.consecutiveTBJData && tbjStats.consecutiveTBJData.length > 0) {
                        const details = tbjStats.consecutiveTBJData
                            .filter(data => data.count > 1)  // 只显示连续次数大于1的
                            .sort((a, b) => b.count - a.count)  // 按连续次数从大到小排序
                            .map(data => {
                                const frames = `帧 ${data.startFrame}-${data.endFrame}`;
                                return `<div class="consecutive-item">${frames}: ${data.count} 次</div>`;
                            })
                            .join('');
                        detailsElement.innerHTML = details || '<div class="consecutive-item">无连续TBJ</div>';
                    } else {
                        detailsElement.innerHTML = '<div class="consecutive-item">无连续TBJ</div>';
                    }
                    
                    // 更新平均速度统计信息
                    const speedDetailsElement = document.getElementById('timerSpeedDetails');
                    if (chartData.timerStats && chartData.timerStats.length > 0) {
                        const speedDetails = chartData.timerStats
                            .map(timer => {
                                return `
                                    <div class="stat-item speed-stat-item">
                                        <div class="speed-main-info">
                                            <span class="speed-value">${timer.averageSpeed}</span>
                                            <span class="speed-unit">u/s</span>
                                        </div>
                                        <div class="speed-details">
                                            <div class="frame-range">帧范围: ${timer.startFrame}-${timer.endFrame}</div>
                                            <div class="frame-duration">持续: ${timer.frameDuration} 帧</div>
                                        </div>
                                    </div>`;
                            })
                            .join('');
                        speedDetailsElement.innerHTML = speedDetails || '<div class="stat-item">无计时器数据</div>';
                    } else {
                        speedDetailsElement.innerHTML = '<div class="stat-item">无计时器数据</div>';
                    }
                });

                demoReader.parse(file);
            }).catch((error) => {
                console.error('Error storing file:', error);
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                Array.from(files).forEach((file, index) => {
                    processFile(file, index);
                });
                // 刷新文件列表
                generateFileTable('#fileList');
            }
        }

        // 打开对比弹窗
        function openCompareDialog() {
            const dialog = document.getElementById('compareDialog');
            dialog.style.display = 'block';
            
            // 获取所有已加载的demo文件
            retrieveAllFiles().then(files => {
                const newSelect = document.getElementById('newRecordSelect');
                const oldSelect = document.getElementById('oldRecordSelect');
                
                // 清空现有选项
                newSelect.innerHTML = '';
                oldSelect.innerHTML = '';
                
                // 只添加demo文件
                files.forEach(file => {
                    if (file.file.name.endsWith('.dem')) {  // 只显示demo文件
                        const option = document.createElement('option');
                        option.value = file.file.name;
                        option.textContent = file.file.name;
                        
                        newSelect.appendChild(option.cloneNode(true));
                        oldSelect.appendChild(option);
                    }
                });
            });
        }

        // 关闭对比弹窗
        function closeCompareDialog() {
            document.getElementById('compareDialog').style.display = 'none';
        }

        // 对比记录
        function compareRecords() {
            const newRecordId = document.getElementById('newRecordSelect').value;
            const oldRecordId = document.getElementById('oldRecordSelect').value;
            
            if (!newRecordId || !oldRecordId) {
                alert('请选择要对比的记录');
                return;
            }
            
            Promise.all([
                retrieveFile(newRecordId),
                retrieveFile(oldRecordId)
            ]).then(([newRecord, oldRecord]) => {
                console.log("New Record:", newRecord); // 调试输出
                console.log("Old Record:", oldRecord); // 调试输出
                
                // 直接使用DemoReader解析文件
                const newDemoReader = new HLDemo.DemoReader();
                const oldDemoReader = new HLDemo.DemoReader();
                
                Promise.all([
                    new Promise((resolve) => {
                        newDemoReader.onready = function() {
                            const frames = newDemoReader.directoryEntries[1].frames;
                            const parsedData = parseFrames(frames);
                            const processedData = preprocessOriginData(parsedData);
                            resolve(processedData);
                        };
                        newDemoReader.parse(newRecord.file);
                    }),
                    new Promise((resolve) => {
                        oldDemoReader.onready = function() {
                            const frames = oldDemoReader.directoryEntries[1].frames;
                            const parsedData = parseFrames(frames);
                            const processedData = preprocessOriginData(parsedData);
                            resolve(processedData);
                        };
                        oldDemoReader.parse(oldRecord.file);
                    })
                ]).then(([newRecordData, oldRecordData]) => {
                    console.log("Processed New Record Data:", newRecordData);
                    console.log("Processed Old Record Data:", oldRecordData);
                    
                    const frameDistances = calculateFrameDistances(newRecordData, oldRecordData);
                    console.log("Frame Distances:", frameDistances); // 调试输出
                    
                    // 保存结果
                    const resultBlob = new Blob(
                        [JSON.stringify(frameDistances, null, 2)],
                        { type: 'application/json' }
                    );
                    const url = URL.createObjectURL(resultBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `frame_distances_${newRecordId.split('.')[0]}_vs_${oldRecordId.split('.')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    closeCompareDialog();
                }).catch(error => {
                    console.error('Error processing demo files:', error);
                    alert('处理记录时出错');
                });
            }).catch(error => {
                console.error('Error retrieving files:', error);
                alert('获取文件时出错');
            });
        }

        // 添加预处理函数
        function preprocessOriginData(data) {
            const startFrame = data.timer.start.frame;
            const endFrame = data.timer.end.frame;
            const processedData = { x: {}, y: {}, z: {} };

            // 遍历指定范围内的帧
            for (let frame = startFrame; frame <= endFrame; frame++) {
                const frameStr = frame.toString();
                const newFrameStr = (frame - startFrame).toString();  // 从0开始的新帧序号
                
                if (frameStr in data.origin.x && 
                    frameStr in data.origin.y && 
                    frameStr in data.origin.z) {
                    processedData.x[newFrameStr] = data.origin.x[frameStr];
                    processedData.y[newFrameStr] = data.origin.y[frameStr];
                    processedData.z[newFrameStr] = data.origin.z[frameStr];
                }
            }

            return {
                timer: data.timer,
                origin: processedData
            };
        }

        // 修改calculateFrameDistances函数
        function calculateFrameDistances(newRecordData, oldRecordData) {
            console.log("Timer Data:", {
                startFrame: newRecordData.timer.start.frame,
                endFrame: newRecordData.timer.end.frame,
                oldStartFrame: oldRecordData.timer.start.frame,
                oldEndFrame: oldRecordData.timer.end.frame
            });
            
            const frameDistances = {};
            const newStartFrame = newRecordData.timer.start.frame;
            const newEndFrame = newRecordData.timer.end.frame;
            const oldStartFrame = oldRecordData.timer.start.frame;
            const oldEndFrame = oldRecordData.timer.end.frame;
            
            // 新记录的帧范围
            const newFrameRange = newEndFrame - newStartFrame;
            // 老记录的帧范围
            const oldFrameRange = oldEndFrame - oldStartFrame;
            
            console.log("Frame Ranges:", {
                new: newFrameRange,
                old: oldFrameRange,
                newData: Object.keys(newRecordData.origin.x).length,
                oldData: Object.keys(oldRecordData.origin.x).length
            });
            
            // 处理每一帧
            for (let frame = 0; frame <= newFrameRange; frame++) {
                const frameStr = frame.toString();
                
                // 获取当前点的坐标
                const currentPoint = {
                    x: parseFloat(newRecordData.origin.x[frameStr]),
                    y: parseFloat(newRecordData.origin.y[frameStr]),
                    z: parseFloat(newRecordData.origin.z[frameStr])
                };
                
                // 计算实际距离（如果同帧存在）
                let realDistance = null;
                if (frameStr in oldRecordData.origin.x) {
                    const sameFramePoint = {
                        x: parseFloat(oldRecordData.origin.x[frameStr]),
                        y: parseFloat(oldRecordData.origin.y[frameStr]),
                        z: parseFloat(oldRecordData.origin.z[frameStr])
                    };
                    realDistance = Math.sqrt(
                        (currentPoint.x - sameFramePoint.x) ** 2 +
                        (currentPoint.y - sameFramePoint.y) ** 2 +
                        (currentPoint.z - sameFramePoint.z) ** 2
                    );
                }
                
                // 寻找最近的帧
                let minDist = Infinity;
                let closestFrame = null;
                
                // 遍历老记录的所有可能帧
                for (let oldFrameRaw = oldStartFrame; oldFrameRaw <= oldEndFrame; oldFrameRaw++) {
                    const oldFrame = oldFrameRaw - oldStartFrame;  // 转换为相对帧号
                    const oldFrameStr = oldFrame.toString();
                    
                    if (!(oldFrameStr in oldRecordData.origin.x)) continue;
                    
                    const oldPoint = {
                        x: parseFloat(oldRecordData.origin.x[oldFrameStr]),
                        y: parseFloat(oldRecordData.origin.y[oldFrameStr]),
                        z: parseFloat(oldRecordData.origin.z[oldFrameStr])
                    };
                    
                    // 计算z坐标差
                    const zDiff = oldPoint.z - currentPoint.z;
                    if (zDiff >= 64.0) continue;
                    
                    // 只计算x和y轴的距离
                    const dist = Math.sqrt(
                        (currentPoint.x - oldPoint.x) ** 2 +
                        (currentPoint.y - oldPoint.y) ** 2
                    );
                    
                    // 检查总距离
                    if (dist < 720.0 && dist < minDist) {
                        minDist = dist;
                        closestFrame = oldFrame;
                    }
                }
                
                // 记录符合条件的帧数据
                if (closestFrame !== null && minDist < 720.0) {
                    frameDistances[frameStr] = {
                        realdistance: realDistance !== null ? Math.round(realDistance * 100) / 100 : null,
                        closetdistance: Math.round(minDist * 100) / 100,
                        timediffence: Math.round((frame - closestFrame) / 100.0 * 100) / 100,
                        new_frame: frame + newStartFrame,
                        old_frame: closestFrame + oldStartFrame,
                        new_relative_frame: frame,
                        old_relative_frame: closestFrame
                    };
                }
            }
            
            return frameDistances;
        }
    </script>
    <script>
        // 下载FOG分析数据
        function downloadFogData(fileName) {
            retrieveFile(fileName)
                .then((result) => {
                    if (!result || !result.file) {
                        alert('找不到文件！');
                        return;
                    }

                    const file = result.file;
                    const demoReader = new HLDemo.DemoReader();
                    demoReader.onready(function() {
                        const frames = demoReader.directoryEntries[1].frames;
                        const parsedData = parseFrames(frames);
                        const fogData = calculateFog(parsedData, fileName);
                        
                        const jsonString = JSON.stringify(fogData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName.replace(/\.[^/.]+$/, '') + '_fog_data.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                    
                    demoReader.parse(file);
                })
                .catch((error) => {
                    console.error('Error retrieving file:', error);
                    alert('下载失败：' + error);
                });
        }
    </script>
    <script>
        // 下载Demo数据
        function downloadDemoData(fileName) {
            retrieveFile(fileName)
                .then((result) => {
                    if (!result || !result.file) {
                        alert('找不到文件！');
                        return;
                    }

                    const file = result.file;
                    const demoReader = new HLDemo.DemoReader();
                    demoReader.onready(function() {
                        const frames = demoReader.directoryEntries[1].frames;
                        const parsedData = parseFrames(frames);
                        if (!parsedData || Object.keys(parsedData).length === 0) {
                            alert('解析Demo数据失败！');
                            return;
                        }
                        const demoData = convertDemoData(parsedData, fileName);
                        
                        const jsonString = JSON.stringify(demoData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName.replace(/\.[^/.]+$/, '') + '_demo_data.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                    
                    demoReader.parse(file);
                })
                .catch((error) => {
                    console.error('Error retrieving file:', error);
                    alert('下载失败：' + error);
                });
        }

        // 下载Frames数据
        function downloadFramesData(fileName) {
            retrieveFile(fileName)
                .then((result) => {
                    if (!result || !result.file) {
                        alert('找不到文件！');
                        return;
                    }

                    const file = result.file;
                    const demoReader = new HLDemo.DemoReader();
                    demoReader.onready(function() {
                        const frames = demoReader.directoryEntries[1].frames;
                        const framesData = parseFrames(frames);
                        if (!framesData || Object.keys(framesData).length === 0) {
                            alert('解析Frames数据失败！');
                            return;
                        }
                        
                        const jsonString = JSON.stringify(framesData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName.replace(/\.[^/.]+$/, '') + '_frames_data.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                    
                    demoReader.parse(file);
                })
                .catch((error) => {
                    console.error('Error retrieving file:', error);
                    alert('下载失败：' + error);
                });
        }
    </script>
</body>

</html>