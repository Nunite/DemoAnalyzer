<!DOCTYPE html>
<html>
<head>
    <title>Demo Viewer - TBJ Analysis</title>
    <style>
        /* 防止滚动条导致的页面跳动 */
        html {
            overflow-y: scroll;
            scrollbar-gutter: stable;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #fff;
        }
        .container {
            display: flex;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto 0 300px;
            gap: 20px;
        }
        .file-list {
            width: 300px;
            background: #f5f5f5;
            border-radius: 6px;
            padding: 10px;
            height: fit-content;
        }
        .file-list table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 14px;
        }
        .file-list td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .file-list tr:hover {
            background-color: #f0f0f0;
        }
        .file-list .file-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .file-list .file-name {
            color: #007bff;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: block;
        }
        .file-list .file-name:hover {
            text-decoration: underline;
        }
        .file-list .file-time {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }
        .delete-btn {
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .delete-btn:hover {
            color: #bd2130;
        }
        .tbj-stats {
            position: absolute;
            right: 370px;
            top: 110px;
            width: 180px;
            background: #f5f5f5;
            border-radius: 6px;
            padding: 10px;
            height: fit-content;
            z-index: 1000;
        }
        .tbj-stats h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .tbj-stats .stat-item {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .tbj-stats .stat-item .label {
            color: #666;
            margin-bottom: 3px;
        }
        .tbj-stats .stat-item .value {
            font-weight: bold;
            color: #333;
        }
        .main-content {
            flex: 1;
        }
        .chart-container {
            position: relative;
            border: 1px solid #ddd;
            margin-bottom: -1px;
        }
        .commands-chart {
            height: 300px;
            border-top: none;
        }
        .preview-handle-grip {
            position: absolute;
            width: 8px;
            height: 100%;
            background: rgba(0, 0, 255, 0.5);
            cursor: col-resize;
        }
        .preview-handle-grip.left {
            left: 0;
        }
        .preview-handle-grip.right {
            right: 0;
        }
        .frame-display {
            text-align: center;
            font-size: 16px;
            margin-top: 10px;
        }
        .hover-frame {
            position: absolute;
            top: -20px;
            font-size: 12px;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
            display: none;
        }
        .frame-numbers {
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 20px;
        }
        .vertical-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            display: none;
        }
        .frame-info {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            pointer-events: none;
            display: none;
        }
        .current-frame {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .command-panel {
            position: absolute;
            right: -220px;
            top: 120px;
            width: 180px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .command-option {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .command-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
            vertical-align: middle;
        }
        .chart-container {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .file-info {
            text-align: center;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .upload-button {
            background-color: #f0f0f0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .upload-button:hover {
            background-color: #e0e0e0;
        }
        .analyze-button {
            background-color: #ff6b00;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .analyze-button:hover {
            background-color: #ff5500;
        }
        .info-text {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }
        .echarts-container {
            height: 670px;
            width: 100%;
        }
        .color-picker {
            width: 50px;
            height: 20px;
            border: none;
            padding: 0;
            margin: 0;
        }
        .tbj-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .tbj-panel {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 10px;
            margin-top: 20px;
            display: none;
        }
        .tbj-panel h4 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        #tbjStats {
            display: none;
        }
        .form-check-input {
            margin-right: 5px;
        }
        .analyze-demo {
            cursor: pointer;
        }
        .tool-option {
            margin: 10px 0;
        }
        .tool-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .option-content {
            margin-left: 10px;
        }
        .color-option {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .color-option input[type="color"] {
            margin-right: 10px;
            width: 30px;
            height: 20px;
        }
        .color-option label {
            font-weight: normal;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/hldemo.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/demoDataConverter.js"></script>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error('Error: ' + msg + '\nurl: ' + url + '\nline: ' + line);
            return false;
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="file-list" id="fileList">
            <h3 style="margin-top: 0;">已加载文件</h3>
        </div>
        <div class="tbj-stats">
            <h3>工具选项</h3>
            <div class="tool-option">
                <label>TBJ显示设置</label>
                <div class="option-content">
                    <input type="checkbox" id="showTBJ" onchange="toggleTBJDisplay()">
                    <!-- <label>显示TBJ数据</label> -->
                </div>
            </div>
            <!-- <div class="tool-option">
                <label>Duck指令高亮</label>
                <div class="option-content">
                    <div class="color-option">
                        <input type="color" id="duck-start-highlight" value="#A0522D" onchange="updateDuckHighlight()">
                        <label>起始帧颜色</label>
                    </div>
                    <div class="color-option">
                        <input type="color" id="duck-end-highlight" value="#8B4513" onchange="updateDuckHighlight()">
                        <label>结束帧颜色</label>
                    </div>
                </div>
            </div> -->
        </div>
        <div class="main-content">
            <div class="control-panel">
                <label class="upload-button">
                    <input type="file" accept=".xhr,.dem" multiple style="display: none" onchange="handleFileUpload(event)">
                    上传数据文件
                </label>
            </div>
            <p class="info-text">仅支持.xhr和.dem文件格式 (20MB maximum)</p>
            <div class="chart-container">
                <h3 id="currentFileName" style="text-align: center; margin-bottom: 20px; color: #333;"></h3>
                <div id="chartContainer" class="echarts-container"></div>
                <div class="command-panel">
                    <div class="command-option">
                        <input type="color" class="color-picker" id="yaw-speed-color" value="#1E90FF" style="display: none;">
                        <span class="color-indicator" style="background: #1E90FF" onclick="document.getElementById('yaw-speed-color').click()"></span>
                        <label>Yaw Speed</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="use-color" value="#FF4500" style="display: none;">
                        <span class="color-indicator" style="background: #FF4500" onclick="document.getElementById('use-color').click()"></span>
                        <label>use</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="moveleft-color" value="#32CD32" style="display: none;">
                        <span class="color-indicator" style="background: #32CD32" onclick="document.getElementById('moveleft-color').click()"></span>
                        <label>moveleft</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="moveright-color" value="#9370DB" style="display: none;">
                        <span class="color-indicator" style="background: #9370DB" onclick="document.getElementById('moveright-color').click()"></span>
                        <label>moveright</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="moveforward-color" value="#FFD700" style="display: none;">
                        <span class="color-indicator" style="background: #FFD700" onclick="document.getElementById('moveforward-color').click()"></span>
                        <label>moveforward</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="moveback-color" value="#FF69B4" style="display: none;">
                        <span class="color-indicator" style="background: #FF69B4" onclick="document.getElementById('moveback-color').click()"></span>
                        <label>moveback</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="jump-color" value="#00CED1" style="display: none;">
                        <span class="color-indicator" style="background: #00CED1" onclick="document.getElementById('jump-color').click()"></span>
                        <label>jump</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="valid-jump-color" value="#00FF00" style="display: none;">
                        <span class="color-indicator" style="background: #00FF00" onclick="document.getElementById('valid-jump-color').click()"></span>
                        <label>有效起跳帧</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="ground-color" value="#808080" style="display: none;">
                        <span class="color-indicator" style="background: #808080" onclick="document.getElementById('ground-color').click()"></span>
                        <label>ground</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="duck-color" value="#8B4513" style="display: none;">
                        <span class="color-indicator" style="background: #8B4513" onclick="document.getElementById('duck-color').click()"></span>
                        <label>duck</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="duck-start-color" value="#A0522D" style="display: none;">
                        <span class="color-indicator" style="background: #A0522D" onclick="document.getElementById('duck-start-color').click()"></span>
                        <label>duck起始帧</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="duck-end-color" value="#8B4513" style="display: none;">
                        <span class="color-indicator" style="background: #8B4513" onclick="document.getElementById('duck-end-color').click()"></span>
                        <label>duck结束帧</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="forward-color" value="#4682B4" style="display: none;">
                        <span class="color-indicator" style="background: #4682B4" onclick="document.getElementById('forward-color').click()"></span>
                        <label>forward</label>
                    </div>
                    <div class="command-option">
                        <input type="color" class="color-picker" id="back-color" value="#CD853F" style="display: none;">
                        <span class="color-indicator" style="background: #CD853F" onclick="document.getElementById('back-color').click()"></span>
                        <label>back</label>
                    </div>
                </div>
            </div>
            <div id="tbjStats" class="tbj-panel">
                <h4>TBJ 统计</h4>
                <div class="stat-item">
                    <div class="label">总跳跃次数</div>
                    <div class="value" id="totalJumps">-</div>
                </div>
                <div class="stat-item">
                    <div class="label">成功TBJ次数</div>
                    <div class="value" id="successfulTBJ">-</div>
                </div>
                <div class="stat-item">
                    <div class="label">TBJ成功率</div>
                    <div class="value" id="tbjSuccessRate">-</div>
                </div>
                <div class="stat-item">
                    <div class="label">最长连跳</div>
                    <div class="value" id="maxConsecutiveJumps">-</div>
                </div>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px; color: #666; font-size: 14px; margin-top: 20px; border-top: 1px solid #eee;">
        DemoGraphViewer by Lws 
        <a href="https://github.com/Nunite/DemoAnalyzer" target="_blank" style="color: #0366d6; text-decoration: none;">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" style="width: 20px; vertical-align: middle; margin: 0 5px;">
            GitHub
        </a>
    </footer>

    <script>
        let chart = null;
        let loadedFiles = []; // 存储已加载的文件

        function analyzeTBJFromParsedData(parsedData) {
            let stats = {
                totalJumps: 0,
                successfulTBJ: 0,
                consecutiveJumps: 0,
                maxConsecutiveJumps: 0,
                tbjSuccessRate: 0
            };

            const jumpFrames = parsedData.jump_command_frames;
            const groundFrames = parsedData.ground_frames;

            // 确保数组已排序
            jumpFrames.sort((a, b) => a - b);
            groundFrames.sort((a, b) => a - b);

            let currentConsecutiveJumps = 0;
            let lastJumpFrame = -1;

            for (let i = 0; i < jumpFrames.length; i++) {
                const jumpFrame = jumpFrames[i];
                
                // 检查跳跃前是否在地面上
                const isOnGround = groundFrames.some(gf => gf === jumpFrame - 1);
                
                if (isOnGround) {
                    stats.totalJumps++;
                    
                    // 检查是否是TBJ (距离上次跳跃只有1-2个tick)
                    if (lastJumpFrame !== -1 && jumpFrame - lastJumpFrame <= 2) {
                        stats.successfulTBJ++;
                        currentConsecutiveJumps++;
                        stats.maxConsecutiveJumps = Math.max(stats.maxConsecutiveJumps, currentConsecutiveJumps);
                    } else {
                        currentConsecutiveJumps = 1;
                    }
                    
                    lastJumpFrame = jumpFrame;
                }
            }

            // 计算成功率
            stats.tbjSuccessRate = stats.totalJumps > 0 ? 
                ((stats.successfulTBJ / stats.totalJumps) * 100).toFixed(1) + '%' : 
                '0%';

            return stats;
        }

        function handleFileUpload(event) {
            console.log('文件上传开始');
            const files = event.target.files;
            console.log('文件数量:', files.length);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('处理文件:', file.name);
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log('文件已加载:', file.name);
                    const demoReader = new HLDemo.DemoReader();
                    
                    demoReader.onready = function() {
                        console.log('Demo解析成功');
                        try {
                            const frames = demoReader.directoryEntries[1].frames;
                            console.log('帧数:', frames.length);
                            
                            // 使用main.js中的parseFrames处理数据
                            const parsedData = parseFrames(frames);
                            console.log('解析后的数据:', parsedData);
                            
                            // 使用解析后的数据分析TBJ
                            const tbjStats = analyzeTBJFromParsedData(parsedData);
                            console.log('TBJ统计:', tbjStats);
                            
                            // 更新TBJ统计信息显示
                            document.getElementById('totalJumps').textContent = tbjStats.totalJumps;
                            document.getElementById('successfulTBJ').textContent = tbjStats.successfulTBJ;
                            document.getElementById('tbjSuccessRate').textContent = tbjStats.tbjSuccessRate;
                            document.getElementById('maxConsecutiveJumps').textContent = tbjStats.maxConsecutiveJumps;
                            
                            // 初始化图表
                            const chartData = convertDemoData(parsedData);
                            initChart(chartData);
                            
                            // 显示文件名
                            document.getElementById('currentFileName').textContent = '当前文件：' + file.name;
                        } catch (error) {
                            console.error('处理Demo时出错:', error);
                        }
                    };
                    
                    demoReader.onerror = function(error) {
                        console.error('Demo读取错误:', error);
                    };

                    try {
                        const blob = new Blob([e.target.result]);
                        const demoFile = new File([blob], file.name);
                        console.log('开始解析demo文件...');
                        demoReader.parse(demoFile);
                    } catch (error) {
                        console.error('创建demo文件时出错:', error);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('文件读取错误:', error);
                };
                
                reader.readAsArrayBuffer(file);
            }
        }

        function initChart(demoData) {
            chart = echarts.init(document.getElementById('chartContainer'));
            
            // 处理数据
            const frames = demoData.data.map(d => d.frame);
            const yawSpeeds = demoData.data.map(d => d.yawSpeed);
            
            const option = {
                title: [
                    { top: 205, left: 5, text: "Yaw Speed", textStyle: { fontSize: 12 } },
                    { top: 345, left: 5, text: "use", textStyle: { fontSize: 12 } },
                    { top: 375, left: 5, text: "moveleft", textStyle: { fontSize: 12 } },
                    { top: 405, left: 5, text: "moveright", textStyle: { fontSize: 12 } },
                    { top: 435, left: 5, text: "moveforward", textStyle: { fontSize: 12 } },
                    { top: 465, left: 5, text: "moveback", textStyle: { fontSize: 12 } },
                    { top: 495, left: 5, text: "jump", textStyle: { fontSize: 12 } },
                    { top: 525, left: 5, text: "ground", textStyle: { fontSize: 12 } },
                    { top: 555, left: 5, text: "duck", textStyle: { fontSize: 12 } },
                    { top: 585, left: 5, text: "forward", textStyle: { fontSize: 12 } },
                    { top: 615, left: 5, text: "back", textStyle: { fontSize: 12 } }
                ],
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        // 找到当前帧的索引
                        const frameIndex = params[0].dataIndex;
                        const frame = frames[frameIndex];
                        
                        // 构建显示信息
                        let result = `Frame: ${frame}<br/>`;
                        
                        // 获取所有数据系列的值
                        const seriesValues = {
                            'Yaw Speed': yawSpeeds[frameIndex],
                            'use': demoData.data[frameIndex].use ? 'Yes' : 'No',
                            'moveleft': demoData.data[frameIndex].moveleft ? 'Yes' : 'No',
                            'moveright': demoData.data[frameIndex].moveright ? 'Yes' : 'No',
                            'moveforward': demoData.data[frameIndex].moveforward ? 'Yes' : 'No',
                            'moveback': demoData.data[frameIndex].moveback ? 'Yes' : 'No',
                            'jump': demoData.data[frameIndex].jump ? 'Yes' : 'No',
                            'ground': demoData.data[frameIndex].ground ? 'Yes' : 'No',
                            'duck': demoData.data[frameIndex].duck ? 'Yes' : 'No',
                            'forward': demoData.data[frameIndex].forward ? 'Yes' : 'No',
                            'back': demoData.data[frameIndex].back ? 'Yes' : 'No'
                        };

                        // 添加每个系列的值
                        Object.entries(seriesValues).forEach(([name, value]) => {
                            if (typeof value === 'number') {
                                result += `${name}: ${value.toFixed(6)}<br/>`;
                            } else {
                                result += `${name}: ${value}<br/>`;
                            }
                        });

                        return result;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#ccc',
                    borderWidth: 1,
                    padding: [5, 10],
                    textStyle: {
                        color: '#333'
                    }
                },
                dataZoom: [{
                    type: 'slider',
                    xAxisIndex: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    top: 50,
                    height: 20,
                    zoomOnMouseWheel: 'ctrl',
                    moveOnMouseWheel: true,
                    moveOnMouseMove: false
                }, {
                    type: 'inside',
                    xAxisIndex: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    zoomOnMouseWheel: 'ctrl',
                    moveOnMouseWheel: true,
                    moveOnMouseMove: false
                }],
                grid: [
                    { left: 120, right: 20, top: 90, height: 250, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 340, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 370, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 400, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 430, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 460, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 490, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 520, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 550, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 580, borderWidth: 2, show: true },
                    { left: 120, right: 20, height: 30, top: 610, borderWidth: 2, show: true }
                ],
                xAxis: Array.from({ length: 11 }, (_, i) => ({
                    type: 'category',
                    data: frames,
                    gridIndex: i,
                    show: i === 10
                })),
                yAxis: Array.from({ length: 11 }, (_, i) => ({
                    type: 'value',
                    gridIndex: i,
                    show: i === 0,
                    min: i === 0 ? null : 0,
                    max: i === 0 ? null : 1
                })),
                series: [
                    {
                        name: 'Yaw Speed',
                        type: 'line',
                        data: yawSpeeds,
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('yaw-speed-color').value
                        }
                    },
                    {
                        name: 'use',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: demoData.data.map(d => d.use),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('use-color').value
                        }
                    },
                    {
                        name: 'moveleft',
                        type: 'bar',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        data: demoData.data.map(d => d.moveLeft),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('moveleft-color').value
                        }
                    },
                    {
                        name: 'moveright',
                        type: 'bar',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        data: demoData.data.map(d => d.moveRight),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('moveright-color').value
                        }
                    },
                    {
                        name: 'moveforward',
                        type: 'bar',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        data: demoData.data.map(d => d.moveForward),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('moveforward-color').value
                        }
                    },
                    {
                        name: 'moveback',
                        type: 'bar',
                        xAxisIndex: 5,
                        yAxisIndex: 5,
                        data: demoData.data.map(d => d.moveBack),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('moveback-color').value
                        }
                    },
                    {
                        name: 'jump',
                        type: 'bar',
                        xAxisIndex: 6,
                        yAxisIndex: 6,
                        data: demoData.data.map(d => ({
                            value: d.jump ? 1 : 0,
                            itemStyle: {
                                color: d.validJump ? document.getElementById('valid-jump-color').value : 
                                                   document.getElementById('jump-color').value
                            }
                        })),
                        animation: false,
                        show: true
                    },
                    {
                        name: 'ground',
                        type: 'bar',
                        xAxisIndex: 7,
                        yAxisIndex: 7,
                        data: demoData.data.map(d => d.ground ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('ground-color').value
                        }
                    },
                    {
                        name: 'duck',
                        type: 'bar',
                        xAxisIndex: 8,
                        yAxisIndex: 8,
                        data: demoData.data.map((d, index, array) => {
                            if (!d.duck) return 0;
                            
                            // 检查当前帧是否是一段连续duck的起始或结束
                            let isStart = false;
                            let isEnd = false;
                            
                            // 判断是否是起始帧：当前帧是duck且前一帧不是duck
                            if (index === 0 || !array[index - 1].duck) {
                                isStart = true;
                            }
                            
                            // 判断是否是结束帧：当前帧是duck且后一帧不是duck
                            if (index === array.length - 1 || !array[index + 1].duck) {
                                isEnd = true;
                            }
                            
                            // 根据帧的位置返回不同的样式
                            return {
                                value: 1,
                                itemStyle: {
                                    color: isStart ? document.getElementById('duck-start-color').value :
                                           isEnd ? document.getElementById('duck-end-color').value :
                                           document.getElementById('duck-color').value
                                }
                            };
                        }),
                        animation: false,
                        show: true
                    },
                    {
                        name: 'forward',
                        type: 'bar',
                        xAxisIndex: 9,
                        yAxisIndex: 9,
                        data: demoData.data.map(d => d.forward ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('forward-color').value
                        }
                    },
                    {
                        name: 'back',
                        type: 'bar',
                        xAxisIndex: 10,
                        yAxisIndex: 10,
                        data: demoData.data.map(d => d.back ? 1 : 0),
                        animation: false,
                        show: true,
                        itemStyle: {
                            color: document.getElementById('back-color').value
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        }

        function analyzeDemo() {
            // 加载示例 .xhr 文件
            fetch('hrbg_rabbitrun_outside_0121.59.xhr')
                .then(response => response.json())
                .then(demoData => {
                    document.getElementById('currentFileName').textContent = '当前文件：' + demoData.fileName;
                    initChart(demoData);
                })
                .catch(error => {
                    alert("Could not load example demo file");
                });
        }

        // 页面加载时不自动初始化图表，等待用户操作
        window.addEventListener('load', () => {
            // 可以选择自动加载示例文件
            // analyzeDemo();
        });

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            chart && chart.resize();
        });

        document.addEventListener('DOMContentLoaded', function() {
            const colorPickers = document.querySelectorAll('.color-picker');
            
            // 加载保存的颜色
            colorPickers.forEach(picker => {
                const savedColor = localStorage.getItem(picker.id);
                if (savedColor) {
                    picker.value = savedColor;
                    picker.nextElementSibling.style.background = savedColor;
                    const seriesName = picker.parentNode.querySelector('label').textContent.trim();
                    updateChartColor(seriesName, savedColor);
                }

                picker.addEventListener('input', function() {
                    const selectedColor = this.value;
                    this.nextElementSibling.style.background = selectedColor;
                    localStorage.setItem(this.id, selectedColor);
                    const seriesName = this.parentNode.querySelector('label').textContent.trim();
                    updateChartColor(seriesName, selectedColor);
                });
            });
        });

        function updateChartColor(seriesName, color) {
            if (!chart) return;
            const option = chart.getOption();
            const seriesIndex = option.series.findIndex(s => s.name === seriesName);
            if (seriesIndex !== -1) {
                option.series[seriesIndex].itemStyle.color = color;
                chart.setOption(option);
            }
        }

        function updateDuckHighlight() {
            // 重新渲染图表以应用新的颜色设置
            if (window.chart) {
                initChart();
            }
        }

        function toggleTBJDisplay() {
            const tbjPanel = document.getElementById('tbjStats');
            const showTBJ = document.getElementById('showTBJ').checked;
            tbjPanel.style.display = showTBJ ? 'block' : 'none';
        }

        // 页面加载时初始化TBJ面板显示状态
        window.addEventListener('load', () => {
            toggleTBJDisplay();
            // 初始化文件列表
            generateFileTable('#fileList');
        });

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('fileStore', 1);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore('files', { keyPath: 'id' });
                };
                
                request.onsuccess = (e) => {
                    resolve(e.target.result);
                };
                
                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        function retrieveAllFiles() {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function processFileFromDatabase(file_id, index = 0) {
            retrieveFile(file_id)
                .then(({file}) => {
                    // 更新文件名标题
                    document.getElementById('currentFileName').textContent = '当前文件：' + file.name;
                    processFile(file, index);
                })
                .catch((error) => {
                    console.error('Error processing file from database:', error);
                });
        }

        function retrieveFile(file_id) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(file_id);

                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        if (result) {
                            resolve({
                                file: result.file,
                                metadata: result.metadata || {}
                            });
                        } else {
                            reject('File not found');
                        }
                    };

                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function formatFileSize(sizeInBytes) {
            const units = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            let size = sizeInBytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return `${minutes} 分钟前`;
                }
                return `${hours} 小时前`;
            } else if (days < 7) {
                return `${days} 天前`;
            } else {
                return new Date(date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function generateFileTable(containerClass) {
            retrieveAllFiles()
            .then((files) => {
                files.reverse();
                let html = '<h3>已加载文件</h3>';
                html += '<table>';
                html += '<tbody>';

                files.forEach(file => {
                    const data = file.file;
                    const timeStr = formatDate(data.lastModified);
                    
                    html += `
                        <tr>
                            <td>
                                <div class="file-info">
                                    <div>
                                        <a href="#" class="file-name" onclick="processFileFromDatabase('${data.name}', 99);" title="${data.name}">
                                            ${data.name.length > 25 ? data.name.substring(0, 22) + '...' : data.name}
                                        </a>
                                        <div class="file-time">${timeStr}</div>
                                    </div>
                                    <span class="delete-btn" onclick="deleteFile('${data.name}')" title="删除">×</span>
                                </div>
                            </td>
                        </tr>`;
                });

                html += '</tbody></table>';
                document.querySelector(containerClass).innerHTML = html;
            })
            .catch((error) => {
                console.error('Error retrieving files:', error);
            });
        }

        function deleteFile(fileId) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.delete(fileId);
                    
                    request.onsuccess = () => {
                        generateFileTable('#fileList');
                        resolve('File deleted successfully');
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function storeFile(file) {
            return openDatabase().then((db) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = {
                        id: file.name,
                        file: file
                    };
                    const request = store.put(fileData);
                    
                    request.onsuccess = () => {
                        resolve('File stored successfully');
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            });
        }

        function processFile(file, index = 0) {
            storeFile(file).then(() => {
                const demoReader = new HLDemo.DemoReader();
                demoReader.onready(function() {
                    const frames = demoReader.directoryEntries[1].frames;
                    const parsedData = parseFrames(frames);
                    
                    // 初始化图表
                    const chartData = convertDemoData(parsedData);
                    chartData.fileName = file.name;
                    initChart(chartData);
                    
                    // 更新TBJ统计信息
                    const tbjStats = analyzeTBJ(frames);
                    document.getElementById('totalJumps').textContent = tbjStats.totalJumps;
                    document.getElementById('successfulTBJ').textContent = tbjStats.successfulTBJ;
                    document.getElementById('tbjSuccessRate').textContent = tbjStats.tbjSuccessRate;
                    document.getElementById('maxConsecutiveJumps').textContent = tbjStats.maxConsecutiveJumps;
                });
                
                demoReader.parse(file);
            }).catch((error) => {
                console.error('Error storing file:', error);
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                Array.from(files).forEach((file, index) => {
                    processFile(file, index);
                });
                // 刷新文件列表
                generateFileTable('#fileList');
            }
        }
    </script>
</body>
</html>